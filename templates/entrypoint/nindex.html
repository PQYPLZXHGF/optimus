{% extends 'nbase.html' %}
{% load static %}

{% block title %}
	Optimus | Dash
{% endblock %}
{% block customcss %}
<link href={% static 'css/optimus/optimus.css' %} rel="stylesheet">
<link href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet"> 
{% endblock %}

{% block customscript %}




{% endblock %}

{% block body %}

<nav class="navbar  navbar-default">
         <div class="container">

        <!--Modal-->
        <div id="publish_deal_live" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times; </button>
                        <h4 class="modal-title" id="myModalLabel">Preview Deal</h4>
                    </div>
                    <div class="modal-body">
                      

                          <div class="row">
                            <div class="col-md-12">
                            <h4 id="deal_title_modal">  1 Non-Veg Wicked Wrap + 1 Dunkaccino Coffee (Regular)
                             </h4><br/>
                            </div>
                          </div>



                                <div class="row" id="images" align="center">

                                    <div class="col-md-4 col-sm-4 col-xs-4  ">
                                        <img src="http://via.placeholder.com/210x210" id="img_1_modal">
                                    </div>

                                    <div class="col-md-1 col-sm-1 col-xs-1  ">
                                    </div>

                                    <div class="col-md-4 col-sm-4 col-xs-4  ">
                                        <img src="http://via.placeholder.com/210x210" id="img_2_modal">
                                        <br/>
                                    </div>



                                  </div>




                                <div class="row" id="deal-detail-location">

                                    <div class="col-md-9 col-sm-9 col-xs-9 temp_bg9">
                                        <p id="dist">12 minutes away</p>
                                    </div>
                                    <div class="col-md-3 col-sm-3 col-xs-3 temp_bg5 ">
                                        <p>
                                            <del id="old_p_modal">&#8377 Old Price</del>
                                        </p>
                                    </div>
                                </div>
                                <div class="row" id="deal-detail-location">

                                    <div class="col-md-9 col-sm-9 col-xs-9 temp_bg3 temp_bg1">
                                        <p id="merchant_name_modal">The Dunkin Donuts, Sector 18, Noida</p>
                                    </div>
                                    <div class="col-md-3 col-sm-3 col-xs-3 temp_bg4 ">
                                        <p id="new_p_modal">&#8377 New Price</p>
                                    </div>
                                </div>                          

                        

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button class="btn btn-primary" id="verify_deal_publish">PUBLISH DEAL</button>

                    </div>
                </div>
            </div>
        </div>



            <div class="navbar-header">
               <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
               <span class="sr-only">Toggle navigation</span>
               <span class="icon-bar"></span>
               <span class="icon-bar"></span>
               <span class="icon-bar"></span>
               </button>
               <a class="navbar-brand" href="#">Optimus</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
               <ul class="nav navbar-nav">
                  <li class="active"><a href="index.html">Dashboard</a></li>
                  <li><a href={% url 'merchants' %}>Merchants</a></li>
                  <li><a href="deals.html">Payements</a></li>
                  <li><a href="post">Deals</a></li>
                  <li><a href="post">Cablets</a></li>
                  <li><a href="post">Advertisements</a></li>
               </ul>
               <ul class="nav navbar-nav navbar-right">
                  <li><a href="index.html">Welcome Merchant</a></li>
                  <li><a href="login.html">Logout</a></li>
               </ul>
            </div>
            <!--/.nav-collapse -->
         </div>
      </nav>
      <section id="breadcrumb">
         <div class="container">
            <ol class="breadcrumb">
               <li class="active">Dashboard</li>
            </ol>
         </div>
      </section>
      <section id="main">
         <div class="container">
            <div class="row">
               <div class="col-md-12">
                  <div class="input-group">
                     <input type="text" class="form-control" placeholder="Search by Merchant ID, Account ID, Deal ID...">
                     <span class="input-group-btn">
                     <button class="btn btn-default" type="button">Find</button>
                     </span>
                  </div>
                  <!-- /input-group -->
                  <br/>
               </div>
               <!-- /.col-lg-6 -->
               <div class="col-md-12">
                  <!--Daily Stats-->
                  <div class="panel panel-default ">
                     <div class="panel-heading main-color-bg">
                        <h3 class="panel-title">Daily Stats</h3>
                     </div>
                     <div class="panel-body">
                        <div class="col-md-3">
                           <div class="well dash-box">
                              <h2><span class="glyphicon glyphicon-user" aria-hidden="true"></span> {{ active_merchants }}<small>/{{ total_merchants }}</small></h2>
                              <h6>Merchants Active</h6>
                           </div>
                        </div>
                        <div class="col-md-3">
                           <div class="well dash-box">
                              <h2><span class="glyphicon glyphicon-check" aria-hidden="true"></span> {{ qadone }}<small>/{{ total_deals_requests }}</small></h2>
                              <h6>QA completed</h6>
                           </div>
                        </div>
                        <div class="col-md-3">
                           <div class="well dash-box">
                              <h2 id = "ads_count"><span class="glyphicon glyphicon-film" aria-hidden="true"></span> 15<small>/90</small></h2>
                              <h6>Daily Ads Displayed</h6>
                           </div>
                        </div>
                        <div class="col-md-3">
                           <div class="well dash-box">
                              <h2><span class="glyphicon glyphicon-road" aria-hidden="true"></span>  6<small>/250</small></h2>
                              <h6>Daily Cablets Active</h6>
                           </div>
                        </div>
                     </div>
                  </div>
                  <!--Tabled-->
                  <div class="panel panel-default">
                     <div class="panel-heading">
                        <h3 class="panel-title">Deal Requests</h3>
                     </div>
                     <div class="panel-body">
                         <div class="row">
                           <div class="col-md-4">
                              <B>Tota Requests</B>
                           </div>
                           <div class="col-md-4">
                              <p>{{ total_deals_requests }}</p>
                           </div>
                           <div class="col-md-4">
                              
                           </div>
                            
                         </div>
                          <div class="row">
                           <div class="col-md-4">
                              <B>QA PASSED</B>
                           </div>
                           <div class="col-md-4">
                              <p>{{ qadone }}</p>
                           </div>
                           <div class="col-md-4">
                              
                           </div>
                            
                         </div>
                         <hr>

                         <div class="row">
                            <div class="col-md-12">
                              <table id="deal_request_table" class="display" width="100%"></table>
                           </div>
                         </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </section>
      <footer id="footer">
         <div class="container">
            <p>BizzInno Strategist  &copy 2017</p>
         </div>
      </footer>

{% endblock %}
{% block bottomscript %}
<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script>
  <script>
      var deal_request_json = {{ deal_request_dict | safe }};
      var deal_to_be_published_info_dict = {};
      var merchant_id = "";
      var deal_content ={};


      console.log("Now Printing data");
      console.log(deal_request_json);

      var id = 0;




      var table = $('#deal_request_table').DataTable({
        "data": deal_request_json ,
        "fnRowCallback": function(nRow, aData, iDisplayIndex) {

                      $('td:eq(0)', nRow).html('<p class="m_id_label">'+aData[0] + '</p>');   

            $('td:eq(1)', nRow).html('<a class="m_name" href="' + aData[0] + '" id='+id+'>' +
                aData[1] + '</a>');

            $('td:eq(4)', nRow).html('<label class="deal_id_label">' +
                aData[4] + '</label>');      

            $('td:eq(6)', nRow).html('<button class = "checkButton" >' +
                aData[6] + '</button>');



            return nRow;
            //id=id+1;
        },
        "columns": [
            { title: "Merchant ID" },
            { title: "Name" },
            { title: "Category" },
            { title: "QA Status" },
            { title: "Deal ID" },
            { title: "Daily Count" },
            { title: "Action" },
        ]



    });


// When clicking the .checkButton 
$("#deal_request_table tbody").on('click', '.checkButton', function() {
    

            //alert('Deal ID is : ' + $(this).closest('tr').find(".deal_id_label").text());
            var deal_to_be_published = $(this).closest('tr').find(".deal_id_label").text();
            var m_id = $(this).closest('tr').find(".m_id_label").text();
            console.log(m_id);

            deal_to_be_published_info_dict["deal_id"] = deal_to_be_published;
            deal_to_be_published_info_dict["merchant_id"]=m_id;

            console.log(deal_to_be_published);
            $("#publish_deal_live").modal('toggle');

            // using jQuery
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            var csrftoken = getCookie('csrftoken');



            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

          data_verify_deal = JSON.stringify(deal_to_be_published_info_dict);
          console.log(data_verify_deal);
          $.ajax({

                          type: "POST",
                          url : '{% url "ep_verify_deal_step_one" %}',
                          contentType: "application/json",
                          data : data_verify_deal,
                          "success": function(data) {
                              if(data.status==1){
                                  console.log(data);
                                deal_content = data;
                                $("#deal_title_modal").text(data.deal_title);
                                $("#img_1_modal").attr("src",data.deal_image_1);
                                $("#img_2_modal").attr("src",data.deal_image_2);
                                $("#old_p_modal").text(data.old_price);
                                $("#new_p_modal").text(data.new_price);
                                $("#merchant_name_modal").text(data.merchant_name);




                              }
                              else
                              {
                                  console.log("ERROR HAppened");
                              }
                                      
                                  },    
                              
                          dataType: "json",
                });



        console.log("SETTTING ON MODAL NOW");
       // parsed_deal_content = JSON.parse(deal_content);
        
        
        console.log(deal_content);
          //$("#deal_title_modal").text(title);

        });
     

$("#verify_deal_publish").click(function(){

              // using jQuery
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            var csrftoken = getCookie('csrftoken');



            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

          data_verify_deal_two = JSON.stringify(deal_to_be_published_info_dict);
          console.log(data_verify_deal_two);

          $.ajax({

                          type: "POST",
                          url : '{% url "ep_verify_deal_step_two" %}',
                          contentType: "application/json",
                          data : data_verify_deal_two,
                          "success": function(data) {
                              if(data.status==1){
                                  console.log("SUBMITTED");

                              }
                              else
                              {
                                  console.log("ERROR HAppened");
                              }
                                      
                                  },    
                              
                          dataType: "json",
                });







  });

 </script>
{% endblock %}

